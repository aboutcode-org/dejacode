{% load i18n %}
{% include 'tabs/pagination.html' %}
<table class="table table-bordered table-md text-break">
  {% include 'includes/object_list_table_header.html' with filter=filterset include_actions=True %}
  <tbody>
    {% for vulnerability in page_obj.object_list %}
      {# TODO: Replace this with a value on the object #}
      {% with affected_packages_count=vulnerability.affected_packages.count %}
      <tr>
        <td rowspan="{{ affected_packages_count }}">
          <strong>
            {% if vulnerability.resource_url %}
              <a href="{{ vulnerability.resource_url }}" target="_blank">
                {{ vulnerability.vulnerability_id }}
                <i class="fa-solid fa-up-right-from-square mini"></i>
              </a>
            {% else %}
              {{ vulnerability.vulnerability_id }}
            {% endif %}
            {% if vulnerability.summary %}
              <span class="float-end" data-bs-toggle="popover" data-bs-placement="right" data-bs-trigger="hover focus" data-bs-content="{{ vulnerability.summary }}">
                <i class="fa-solid fa-circle-info"></i>
              </span>
            {% endif %}
          </strong>
          <div class="mt-2">
            {% include 'component_catalog/includes/vulnerability_aliases.html' with aliases=vulnerability.aliases only %}
          </div>
        </td>
        <td rowspan="{{ affected_packages_count }}">
          {% include 'vulnerabilities/includes/exploitability.html' with instance=vulnerability only %}
        </td>
        <td rowspan="{{ affected_packages_count }}">
          {{ vulnerability.weighted_severity|default_if_none:"" }}
        </td>
        <td  rowspan="{{ affected_packages_count }}" class="fs-110pct">
          {% include 'vulnerabilities/includes/risk_score_badge.html' with risk_score=vulnerability.risk_score only %}
        </td>
        {% for package in vulnerability.affected_packages.all %}
          {% if not forloop.first %}<tr>{% endif %}
          <td>
            <ul class="list-unstyled mb-0">
                <li>
                  <a href="{{ package.get_absolute_url }}#vulnerabilities" target="_blank">{{ package }}</a>
                  {% include 'vulnerabilities/includes/risk_score_badge.html' with risk_score=package.risk_score label='risk' only %}
                </li>
            </ul>
          </td>
          <td>
            {% if vulnerability.vulnerability_analyses.get %}
              <ul class="list-unstyled mb-0">
                {% if vulnerability.vulnerability_analyses.get.state %}
                  <li><strong>{{ vulnerability.vulnerability_analyses.get.get_state_display }}</strong></li>
                {% endif %}
                {% if vulnerability.vulnerability_analyses.get.detail %}
                  <li>Detail: {{ vulnerability.vulnerability_analyses.get.detail }}</li>
                {% endif %}
              </ul>
            {% endif %}
          </td>
          <td>
            {% if vulnerability.vulnerability_analyses.get %}
              {{ vulnerability.vulnerability_analyses.get.get_justification_display }}
            {% endif %}
          </td>
          <td>
            {% if vulnerability.vulnerability_analyses.get.responses %}
              {{ vulnerability.vulnerability_analyses.get.responses|join:"<br>" }}
            {% endif %}
          </td>
          <td class="p-1">
            <span data-bs-toggle="modal"
                  data-bs-target="#vulnerability-analysis-modal"
                  data-vulnerability-id="{{ vulnerability.vulnerability_id }}"
                  data-edit-url="{{ product.get_absolute_url }}vulnerability_analysis_ajax_view/?vulnerability_id={{ vulnerability.vulnerability_id }}"
            >
              <button type="button" data-bs-toggle="tooltip" title="Edit" class="btn btn-link p-0" aria-label="Edit">
                <i class="far fa-edit fa-sm"></i>
              </button>
            </span>
          </td>
          {% if not forloop.first %}</tr>{% endif %}
        {% endfor %}
      </tr>
      {% endwith %}
    {% empty %}
      <tr>
        <td colspan="10">
          No results.
          {% if filterset.is_active %}
            <a href="#" hx-get="{{ request.path }}?all=true#{{ tab_id }}" hx-target="{{ tab_id_html }}">
              Clear search and filters
            </a>
          {% endif %}
        </td>
      </tr>
    {% endfor %}
  </tbody>
</table>